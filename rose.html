<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment Approvals</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="page">
    <section class="card">
      <div class="brand">
        <div class="badge">₹</div>
        <div>
          <h1>Manual Approvals</h1>
          <p class="sub">Approve UTR submissions before lookup.</p>
        </div>
      </div>

      <div id="pendingList" class="result"></div>
      <div id="adminError" class="error hidden"></div>

      <div class="result">
        <div class="result-header">General Chat (Admin View)</div>
        <div id="adminChatList"></div>
      </div>

      <div class="result">
        <div class="result-header">Match Messages (Admin View)</div>
        <div id="adminMatchMessages"></div>
      </div>
    </section>
  </main>

  <script>
    async function loadPending() {
      const res = await fetch('/api/admin/pending');
      const data = await res.json();
      const container = document.getElementById('pendingList');
      container.innerHTML = '';
      if (!data.pending || data.pending.length === 0) {
        container.innerHTML = '<p class="sub">No pending payments.</p>';
        return;
      }

      data.pending.forEach(item => {
        const row = document.createElement('div');
        row.className = 'line';
        row.innerHTML = `
          <span class="label">${item.id}</span>
          <span class="value">${item.name || 'Name: (not provided)'} | Pending: ${item.pending_count || 0} | Credits: ${item.credits || 0} | Used: ${item.used_count || 0}</span>
          <button class="soft" data-id="${item.id}">Approve 1</button>
        `;
        container.appendChild(row);
      });

      container.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
          await fetch('/api/admin/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: btn.dataset.id })
          });
          loadPending();
        });
      });
    }

    async function loadAdminChat() {
      const res = await fetch('/api/admin/chat');
      const data = await res.json();
      const container = document.getElementById('adminChatList');
      container.innerHTML = '';
      (data.messages || []).forEach(item => {
        const row = document.createElement('div');
        row.className = 'line';
        const attachment = item.file_url
          ? `<a class="value" href="${item.file_url}" target="_blank" rel="noreferrer">Attachment</a>`
          : '';
        row.innerHTML = `
          <span class="label">${item.from_id || ''}</span>
          <span class="value">${item.text || ''}</span>
          ${attachment}
          <button class="soft" data-id="${item.id}" data-action="pin">Pin</button>
          <button class="soft" data-id="${item.id}" data-action="delete">Delete</button>
        `;
        container.appendChild(row);
      });

      container.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const action = btn.dataset.action;
          const endpoint = action === 'pin' ? '/api/admin/chat/pin' : '/api/admin/chat/delete';
          await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: btn.dataset.id })
          });
          loadAdminChat();
        });
      });
    }

    async function loadAdminMatchMessages() {
      const res = await fetch('/api/admin/messages');
      const data = await res.json();
      const container = document.getElementById('adminMatchMessages');
      container.innerHTML = '';
      const threads = data.threads || {};
      Object.keys(threads).forEach(key => {
        const header = document.createElement('div');
        header.className = 'line';
        header.innerHTML = `<span class="label">${key}</span><span class="value">${threads[key].length} messages</span>`;
        container.appendChild(header);
        threads[key].forEach(msg => {
          const row = document.createElement('div');
          row.className = 'line';
          row.innerHTML = `<span class="label">${msg.from_id} → ${msg.to_id}</span><span class="value">${msg.text}</span>`;
          container.appendChild(row);
        });
      });
    }

    loadPending();
    loadAdminChat();
    loadAdminMatchMessages();
  </script>
</body>
</html>
